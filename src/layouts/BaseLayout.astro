---
import '../styles/global.css';

interface Props {
  title?: string;
  description?: string;
}

const {
  title = "Binary Ideas AI - AI Automation Services Virginia",
  description = "Transform your Northern Virginia business with custom AI agents that save time, cut costs, and boost revenue"
} = Astro.props;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <title>{title}</title>
  </head>
  <body>
    <slot />
    <script is:inline>
      document.addEventListener('DOMContentLoaded', () => {
        const enforceNewTab = (link) => {
          link.setAttribute('target', '_blank');
          const relParts = new Set(
            (link.getAttribute('rel') ?? '')
              .split(/\s+/)
              .map((value) => value.trim())
              .filter(Boolean)
          );
          relParts.add('noopener');
          relParts.add('noreferrer');
          link.setAttribute('rel', Array.from(relParts).join(' '));
        };

        const ensureBookingLinksOpenInNewTab = () => {
          const selector = 'a[href^="https://api.3sixtycrm.com/widget/bookings/robert-sandiego"]';
          document.querySelectorAll(selector).forEach(enforceNewTab);
        };

        const ensureExternalLinksOpenInNewTab = () => {
          const anchors = document.querySelectorAll('a[href]');
          anchors.forEach((anchor) => {
            const rawHref = anchor.getAttribute('href');
            if (!rawHref) {
              return;
            }

            const href = rawHref.trim();
            if (
              !href ||
              href.startsWith('#') ||
              /^(mailto:|tel:|sms:|javascript:)/i.test(href)
            ) {
              return;
            }

            let destination;
            try {
              destination = new URL(href, window.location.href);
            } catch {
              return;
            }

            if (
              destination.origin === window.location.origin ||
              !['http:', 'https:'].includes(destination.protocol)
            ) {
              return;
            }

            enforceNewTab(anchor);
          });
        };

        const autoLinkBlogPhoneNumbers = () => {
          const scopes = document.querySelectorAll('.seo-content-body');
          if (!scopes.length) {
            return;
          }

          const textPattern = /\(703\)\s*690-9726/g;
          scopes.forEach((scope) => {
            const walker = document.createTreeWalker(scope, NodeFilter.SHOW_TEXT);
            const textNodes = [];

            while (walker.nextNode()) {
              const currentNode = walker.currentNode;
              if (!currentNode || !currentNode.textContent) {
                continue;
              }
              if (!currentNode.textContent.includes('(703) 690-9726')) {
                continue;
              }
              if (currentNode.parentElement?.closest('a[href^="tel:"]')) {
                continue;
              }
              textNodes.push(currentNode);
            }

            textNodes.forEach((node) => {
              const text = node.textContent ?? '';
              const matches = text.match(textPattern);

              if (!matches) {
                return;
              }

              const fragments = text.split(textPattern);
              const replacement = document.createDocumentFragment();

              fragments.forEach((fragment, index) => {
                if (fragment) {
                  replacement.appendChild(document.createTextNode(fragment));
                }

                if (index < matches.length) {
                  const phoneLink = document.createElement('a');
                  phoneLink.href = 'tel:7036909726';
                  phoneLink.textContent = matches[index] ?? '(703) 690-9726';
                  phoneLink.dataset.autoLinkedPhone = 'true';
                  replacement.appendChild(phoneLink);
                }
              });

              node.parentNode?.replaceChild(replacement, node);
            });
          });
        };

        ensureBookingLinksOpenInNewTab();
        ensureExternalLinksOpenInNewTab();
        autoLinkBlogPhoneNumbers();
      });
    </script>
    <script
      type="module"
      src="https://agent.d-id.com/v1/index.js"
      data-name="did-agent"
      data-mode="fabio"
      data-client-key="YXV0aDB8NjgyZjg2YjlkOGNkMGQyOWNkN2RkZTZjOl82RkJuZjYyQlRHWTBVLU1mRWxacg=="
      data-agent-id="agt_BpJ8PODD"
      data-monitor="true"
    ></script>
  </body>
</html>
