---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../Header.astro';
import Footer from '../Footer.astro';
import AboutRobertSanDiego from './AboutRobertSanDiego.astro';
import type { BlogPostContent } from '../../data/blogs/content';
import { blogPostsContent } from '../../data/blogs/content';

type BlogPostPageProps = {
  postEntry: BlogPostContent;
  slugKey?: string;
};

const {
  postEntry,
  slugKey: providedSlugKey
}: BlogPostPageProps = Astro.props;

const slugKey = providedSlugKey ?? postEntry.slugSegments.join('/');

const {
  meta,
  pageTitle,
  Page,
  categories
} = postEntry;

const categoryList = categories ?? [];
const heroImage = meta.heroImage?.src ? meta.heroImage : null;
const dateFormatter = new Intl.DateTimeFormat('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
const formattedDate = dateFormatter.format(new Date(meta.publishDate));

const toCategorySlug = (value: string) =>
  value
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');

const categorySet = new Set(categoryList.map((category) => category.toLowerCase()));
const isSamePost = (post: typeof blogPostsContent[number]) =>
  post.slugSegments.join('/') === slugKey;

const relatedByCategory = blogPostsContent.filter((post) => {
  if (isSamePost(post)) return false;
  if (categorySet.size === 0) return false;
  return post.categories.some((category) => categorySet.has(category.toLowerCase()));
});

const tagSet = new Set(
  (postEntry.tags ?? [])
    .concat(categoryList)
    .map((value) => value.toLowerCase())
);

const relatedByTags = blogPostsContent.filter((post) => {
  if (isSamePost(post)) return false;
  if (relatedByCategory.includes(post)) return false;
  if (tagSet.size === 0) return false;
  const postTags = (post.tags ?? []).concat(post.categories ?? []);
  return postTags.some((tag) => tagSet.has(tag.toLowerCase()));
});

const relatedFallback = blogPostsContent.filter(
  (post) => !isSamePost(post) && !relatedByCategory.includes(post) && !relatedByTags.includes(post)
);

const buildExcerpt = (rawText: string | undefined) => {
  const text = (rawText ?? '').replace(/\s+/g, ' ').trim();
  if (!text) {
    return '';
  }
  const words = text.split(' ');
  const truncated = words.slice(0, 15).join(' ');
  return words.length > 15 ? `${truncated}…` : truncated;
};

const relatedPostCards = [...relatedByCategory, ...relatedByTags, ...relatedFallback]
  .slice(0, 5)
  .map((post) => ({
    href: `/${post.slugSegments.join('/')}/`,
    title: post.meta.title,
    heroSrc: post.meta.heroImage?.src ?? '/img/blog/default.jpg',
    heroAlt: post.meta.heroImage?.alt ?? post.meta.title,
    publishDate: post.meta.publishDate,
    excerpt: buildExcerpt(post.excerpt ?? post.meta.description)
  }));
---

<BaseLayout title={meta.title} description={meta.description}>
  <div class="bg-white w-full min-h-screen flex flex-col relative overflow-x-hidden">
    <Header />

    <main class="z-[1] w-full flex-1 relative bg-[#0a0a0f] pt-[97px]">
      <div class="absolute inset-0 opacity-50 pointer-events-none overflow-hidden">
        <div class="absolute top-0 left-[25%] w-96 h-96">
          <div class="glow-sphere glow-sphere--1 h-full w-full bg-[#2b7fff] rounded-[33554400px] blur-3xl pointer-events-none"></div>
        </div>
        <div class="absolute top-[8%] right-[25%] w-96 h-96">
          <div class="glow-sphere glow-sphere--2 h-full w-full bg-[#ac46ff] rounded-[33554400px] blur-3xl pointer-events-none"></div>
        </div>
        <div class="absolute top-[22%] left-1/2 w-96 h-96 -translate-x-1/2">
          <div class="glow-sphere glow-sphere--3 h-full w-full bg-[#f6329a] rounded-[33554400px] blur-3xl pointer-events-none"></div>
        </div>

        <div class="absolute top-[45%] left-[20%] w-80 h-80 opacity-80">
          <div class="glow-sphere glow-sphere--4 h-full w-full bg-[#ac46ff] rounded-[33554400px] blur-3xl pointer-events-none"></div>
        </div>
        <div class="absolute top-[50%] right-[22%] w-96 h-96 opacity-80">
          <div class="glow-sphere glow-sphere--5 h-full w-full bg-[#2b7fff] rounded-[33554400px] blur-3xl pointer-events-none"></div>
        </div>
        <div class="absolute top-[58%] left-1/2 w-80 h-80 -translate-x-1/2 opacity-80">
          <div class="glow-sphere glow-sphere--6 h-full w-full bg-[#f6329a] rounded-[33554400px] blur-3xl pointer-events-none"></div>
        </div>

        <div class="absolute bottom-[18%] left-[18%] w-72 h-72 opacity-70">
          <div class="glow-sphere glow-sphere--7 h-full w-full bg-[#2b7fff] rounded-[33554400px] blur-3xl pointer-events-none"></div>
        </div>
        <div class="absolute bottom-[12%] right-[24%] w-80 h-80 opacity-70">
          <div class="glow-sphere glow-sphere--8 h-full w-full bg-[#ac46ff] rounded-[33554400px] blur-3xl pointer-events-none"></div>
        </div>
        <div class="absolute bottom-[6%] left-[10%] w-72 h-72 opacity-70">
          <div class="glow-sphere glow-sphere--9 h-full w-full bg-[#f6329a] rounded-[33554400px] blur-3xl pointer-events-none"></div>
        </div>
      </div>


      <div class="relative z-[1] py-20">
        <div class="mx-auto w-full max-w-6xl px-4 md:px-8 lg:px-20">
          <div class="grid gap-12 lg:grid-cols-[minmax(0,2.3fr)_minmax(0,1fr)] lg:items-start">
            <div class="flex flex-col gap-10">
              <section class="w-full">
                <div class="flex flex-col gap-4 text-center lg:text-left">
                  <div class="flex flex-wrap items-center justify-center lg:justify-start gap-3 text-xs md:text-sm uppercase tracking-wide text-[#94a3b8] [font-family:'Segoe_UI_Symbol-Regular',Helvetica]">
                    <time dateTime={meta.publishDate}>{formattedDate}</time>
                    {categoryList.length > 0 && <span class="opacity-60">•</span>}
                    {categoryList.length > 0 && (
                      <ul class="flex flex-wrap items-center justify-center gap-2 lg:justify-start">
                        {categoryList.map((category) => (
                          <li>
                            <a
                              href={`/blog/category/${toCategorySlug(category)}/`}
                              class="text-[#94a3b8] hover:text-[#8dc5ff] transition-colors duration-150"
                            >
                              {category}
                            </a>
                          </li>
                        ))}
                      </ul>
                    )}
                  </div>
                  <h1 class="text-3xl sm:text-4xl md:text-5xl font-normal text-white [font-family:'Segoe_UI_Symbol-Regular',Helvetica]">
                    {pageTitle}
                  </h1>
                </div>
              </section>

              <section class="w-full">
                <article class="seo-content-body text-base md:text-lg text-[#d0d5db] leading-relaxed [font-family:'Segoe_UI_Symbol-Regular',Helvetica]">
                  {heroImage && (
                    <figure class="overflow-hidden rounded-2xl border border-[#fffefe1a] bg-[#fffefe0d] backdrop-blur-sm">
                      <img
                        src={heroImage.src}
                        alt={heroImage.alt ?? meta.title}
                        class="w-full h-[260px] md:h-[340px] object-cover"
                        loading="lazy"
                      />
                    </figure>
                  )}
                  <Page />
                </article>
              </section>

              {postEntry.tags?.length ? (
                <section class="w-full mb-0">
                  <div class="flex flex-wrap gap-2">
                    {postEntry.tags.map((tag) => (
                      <a
                        href={`/blog/tags/${toCategorySlug(tag)}/`}
                        class="rounded-full border border-[#2b7fff59] bg-[#2b7fff1a] px-4 py-2 text-sm text-[#8dc5ff] transition-colors duration-150 hover:bg-[#2b7fff33] [font-family:'Segoe_UI_Symbol-Regular',Helvetica]"
                      >
                        #{tag}
                      </a>
                    ))}
                  </div>
                </section>
              ) : null}

              <div class="mt-6 md:mt-[50px]">
                <AboutRobertSanDiego />
              </div>
            </div>

            <aside class="flex flex-col gap-6 rounded-3xl border border-[#fffefe1a] bg-[#0f1524]/70 p-6 backdrop-blur-md lg:sticky lg:top-[160px]">
              <div class="flex flex-col gap-2 text-left">
                <h2 class="text-lg md:text-xl font-semibold text-white [font-family:'Segoe_UI_Symbol-Regular',Helvetica]">
                  Related posts
                </h2>
                <p class="text-sm text-[#cbd4e6] leading-relaxed [font-family:'Segoe_UI_Symbol-Regular',Helvetica]">
                  Explore more articles connected to this topic.
                </p>
              </div>

              {relatedPostCards.length > 0 ? (
                <div class="flex flex-col gap-5">
                  {relatedPostCards.map((related) => (
                    <article class="rounded-2xl border border-[#fffefe1a] flex flex-col p-4 gap-3">
                      <time
                        dateTime={related.publishDate}
                        class="text-xs font-medium uppercase tracking-wide text-[#94a3b8] [font-family:'Segoe_UI_Symbol-Regular',Helvetica]"
                      >
                        {dateFormatter.format(new Date(related.publishDate))}
                      </time>
                      <h3 class="text-base font-semibold leading-snug text-white [font-family:'Segoe_UI_Symbol-Regular',Helvetica]">
                        <a
                          href={related.href}
                          class="hover:text-[#8dc5ff] transition-colors duration-150"
                          aria-label={`Read more about ${related.title}`}
                        >
                          {related.title}
                        </a>
                      </h3>
                      {related.excerpt && (
                        <p class="text-sm text-[#d0d5db] leading-relaxed [font-family:'Segoe_UI_Symbol-Regular',Helvetica]">
                          {related.excerpt}
                        </p>
                      )}
                      <a
                        href={related.href}
                        class="text-sm font-semibold text-white hover:text-[#8dc5ff] transition-colors duration-150 [font-family:'Segoe_UI_Symbol-Regular',Helvetica]"
                        aria-label={`Read more: ${related.title}`}
                      >
                        Read more →
                      </a>
                    </article>
                  ))}
                </div>
              ) : (
                <p class="text-sm text-[#cbd4e6] leading-relaxed [font-family:'Segoe_UI_Symbol-Regular',Helvetica]">
                  More related articles are on the way.
                </p>
              )}
            </aside>
          </div>
        </div>
      </div>

      <section class="relative isolate overflow-hidden px-6 py-24 text-center text-white bg-[linear-gradient(120deg,#06152d_0%,#1a021f_100%)]">
        <div
          class="pointer-events-none absolute left-1/2 top-[-240px] h-[620px] w-[620px] -translate-x-1/2 rounded-full bg-[radial-gradient(circle,rgba(124,58,237,0.45)_0%,rgba(124,58,237,0)_70%)] blur-[140px] opacity-70"
          aria-hidden="true"
        />
        <div
          class="pointer-events-none absolute right-[-220px] top-[160px] h-[540px] w-[540px] rounded-full bg-[radial-gradient(circle,rgba(59,130,246,0.35)_0%,rgba(59,130,246,0)_70%)] blur-[150px] opacity-65"
          aria-hidden="true"
        />
        <div
          class="pointer-events-none absolute left-[-260px] bottom-[-260px] h-[520px] w-[520px] rounded-full bg-[radial-gradient(circle,rgba(168,85,247,0.3)_0%,rgba(168,85,247,0)_70%)] blur-[160px] opacity-60"
          aria-hidden="true"
        />

        <div class="relative mx-auto flex max-w-3xl flex-col items-center gap-8">
          <p class="text-base leading-7 text-[#cbd4e6] sm:text-lg sm:leading-8 [font-family:'Segoe_UI_Symbol-Regular',Helvetica]">
            Don't let inefficient processes hold your business back - discover how AI automation can transform your operations and boost productivity!
          </p>
          <a
            href="https://api.3sixtycrm.com/widget/bookings/robert-sandiego"
            target="_blank"
            rel="noopener"
            class="inline-flex items-center justify-center rounded-[26px] bg-[linear-gradient(90deg,#3785ff_0%,#b020f5_100%)] px-12 py-5 text-lg font-semibold tracking-wide text-white shadow-[0_22px_55px_rgba(94,117,255,0.45)] transition-transform duration-200 hover:scale-[1.04] focus:outline-none focus-visible:ring-4 focus-visible:ring-white/35"
          >
            Book a Complimentary AI Consultation
          </a>
        </div>
      </section>

      <Footer />
    </main>
  </div>
</BaseLayout>

<style is:inline>
  .glow-sphere {
    animation: glowFloat 20s ease-in-out infinite alternate;
    will-change: transform, opacity;
  }

  .glow-sphere--1 {
    animation-duration: 18s;
    animation-delay: -3s;
  }

  .glow-sphere--2 {
    animation-duration: 22s;
    animation-delay: -7s;
    animation-direction: alternate-reverse;
  }

  .glow-sphere--3 {
    animation-duration: 19s;
    animation-delay: -4s;
  }

  .glow-sphere--4 {
    animation-duration: 17s;
    animation-delay: -9s;
  }

  .glow-sphere--5 {
    animation-duration: 23s;
    animation-delay: -13s;
    animation-direction: alternate-reverse;
  }

  .glow-sphere--6 {
    animation-duration: 16s;
    animation-delay: -6s;
  }

  .glow-sphere--7 {
    animation-duration: 21s;
    animation-delay: -10s;
  }

  .glow-sphere--8 {
    animation-duration: 24s;
    animation-delay: -15s;
    animation-direction: alternate-reverse;
  }

  .glow-sphere--9 {
    animation-duration: 17s;
    animation-delay: -8s;
  }

  @keyframes glowFloat {
    0% {
      transform: translate3d(0, 0, 0) scale(1) rotate(0deg);
      opacity: 0.92;
    }

    20% {
      transform: translate3d(70px, -55px, 0) scale(1.08) rotate(2deg);
      opacity: 1;
    }

    40% {
      transform: translate3d(-60px, 45px, 0) scale(0.94) rotate(-2deg);
      opacity: 0.85;
    }

    60% {
      transform: translate3d(80px, 55px, 0) scale(1.12) rotate(3deg);
      opacity: 0.98;
    }

    80% {
      transform: translate3d(-75px, -45px, 0) scale(0.96) rotate(-3deg);
      opacity: 0.88;
    }

    100% {
      transform: translate3d(60px, 35px, 0) scale(1.05) rotate(1deg);
      opacity: 0.95;
    }
  }
</style>

<style is:global>
  .seo-content-body > *:first-child {
    margin-top: 0;
  }

  .seo-content-body p {
    margin-bottom: 1.5rem;
    font-size: 1rem;
    line-height: 1.75;
    color: #d0d5db;
  }

  @media (min-width: 768px) {
    .seo-content-body p {
      font-size: 1.125rem;
    }
  }

  .seo-content-body h2 {
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    font-size: 1.75rem;
    line-height: 1.3;
    font-weight: 400;
    color: #ffffff;
  }

  @media (min-width: 768px) {
    .seo-content-body h2 {
      font-size: 2rem;
    }
  }

  .seo-content-body h3 {
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    font-size: 1.5rem;
    line-height: 1.35;
    font-weight: 400;
    color: #ffffff;
  }

  @media (min-width: 768px) {
    .seo-content-body h3 {
      font-size: 1.75rem;
    }
  }

  .seo-content-body h4,
  .seo-content-body h5 {
    margin-top: 1.75rem;
    margin-bottom: 0.75rem;
    font-size: 1.25rem;
    line-height: 1.4;
    font-weight: 400;
    color: #ffffff;
  }

  .seo-content-body ul,
  .seo-content-body ol {
    margin-bottom: 1.5rem;
    padding-left: 1.25rem;
    color: #d0d5db;
    font-size: 1rem;
    line-height: 1.75;
  }

  @media (min-width: 768px) {
    .seo-content-body ul,
    .seo-content-body ol {
      font-size: 1.125rem;
    }
  }

  .seo-content-body ul {
    list-style-type: disc;
  }

  .seo-content-body ol {
    list-style-type: decimal;
  }

  .seo-content-body li {
    margin-bottom: 0.5rem;
  }

  .seo-content-body figure {
    margin: 2rem 0;
    border: 1px solid rgba(255, 254, 254, 0.1);
    border-radius: 1rem;
    overflow: hidden;
    background: rgba(255, 254, 254, 0.05);
    backdrop-filter: blur(6px);
  }

  .seo-content-body > figure:first-child {
    margin-top: 0;
  }

  .seo-content-body figure img {
    display: block;
    width: 100%;
    height: auto;
    object-fit: cover;
  }

  .seo-content-body figcaption {
    padding: 0.75rem 1.25rem;
    font-size: 0.875rem;
    color: #99a1ae;
  }

  .seo-content-body strong {
    color: #ffffff;
  }

  .seo-content-body a {
    color: #2b7fff;
    text-decoration: underline;
    transition: color 150ms ease, text-decoration-color 150ms ease;
  }

  .seo-content-body a:hover {
    color: #8dc5ff;
  }

  .seo-content-body blockquote {
    border-left: 4px solid rgba(59, 130, 246, 0.4);
    padding-left: 1.25rem;
    margin: 2rem 0;
    color: #cbd4e6;
    font-style: italic;
  }
</style>

