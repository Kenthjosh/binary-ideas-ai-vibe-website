---
import '../styles/global.css';

interface Props {
  title?: string;
  description?: string;
}

const {
  title = "Binary Ideas AI - AI Automation Services Virginia",
  description = "Transform your Northern Virginia business with custom AI agents that save time, cut costs, and boost revenue"
} = Astro.props;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <title>{title}</title>
  </head>
  <body>
    <slot />
    <script is:inline>
      document.addEventListener('DOMContentLoaded', () => {
        const ensureBookingLinksOpenInNewTab = () => {
          const selector = 'a[href^="https://api.3sixtycrm.com/widget/bookings/robert-sandiego"]';
          document.querySelectorAll(selector).forEach((link) => {
            link.setAttribute('target', '_blank');
            const currentRel = link.getAttribute('rel') ?? '';
            const relParts = new Set(
              currentRel
                .split(/\s+/)
                .map((value) => value.trim())
                .filter(Boolean)
            );
            relParts.add('noopener');
            relParts.add('noreferrer');
            link.setAttribute('rel', Array.from(relParts).join(' '));
          });
        };

        const autoLinkBlogPhoneNumbers = () => {
          const scopes = document.querySelectorAll('.seo-content-body');
          if (!scopes.length) {
            return;
          }

          const textPattern = /\(703\)\s*690-9726/g;
          scopes.forEach((scope) => {
            const walker = document.createTreeWalker(scope, NodeFilter.SHOW_TEXT);
            const textNodes = [];

            while (walker.nextNode()) {
              const currentNode = walker.currentNode;
              if (!currentNode || !currentNode.textContent) {
                continue;
              }
              if (!currentNode.textContent.includes('(703) 690-9726')) {
                continue;
              }
              if (currentNode.parentElement?.closest('a[href^="tel:"]')) {
                continue;
              }
              textNodes.push(currentNode);
            }

            textNodes.forEach((node) => {
              const text = node.textContent ?? '';
              const matches = text.match(textPattern);

              if (!matches) {
                return;
              }

              const fragments = text.split(textPattern);
              const replacement = document.createDocumentFragment();

              fragments.forEach((fragment, index) => {
                if (fragment) {
                  replacement.appendChild(document.createTextNode(fragment));
                }

                if (index < matches.length) {
                  const phoneLink = document.createElement('a');
                  phoneLink.href = 'tel:7036909726';
                  phoneLink.textContent = matches[index] ?? '(703) 690-9726';
                  phoneLink.dataset.autoLinkedPhone = 'true';
                  replacement.appendChild(phoneLink);
                }
              });

              node.parentNode?.replaceChild(replacement, node);
            });
          });
        };

        const loadGlobalChatbotEmbed = () => {
          const existingScriptId = 'binary-ideas-chatbot-embed';
          if (document.getElementById(existingScriptId)) {
            return;
          }

          fetch('https://bots.aidrivenbot.com/api/get-chatbot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              chatbotId: '67f95d609fdc31d6bfff4aa3',
              url: window.location.href
            })
          })
            .then((response) => {
              if (response.status === 200) {
                return response.text();
              }
              throw new Error(`Error fetching data, status code: ${response.status}`);
            })
            .then((scriptContent) => {
              const scriptTag = document.createElement('script');
              scriptTag.id = existingScriptId;
              scriptTag.innerHTML = scriptContent;
              document.body.appendChild(scriptTag);
            })
            .catch((error) => {
              console.error('Chatbot embed fetch error:', error);
            });
        };

        ensureBookingLinksOpenInNewTab();
        autoLinkBlogPhoneNumbers();
        loadGlobalChatbotEmbed();
      });
    </script>
  </body>
</html>
