---
type IconName = "phone" | "tool" | "bolt" | "headset";

interface Step {
  id: number;
  stepNumber: string;
  title: string;
  description: string;
  icon?: IconName;
  iconSrc?: string;
  iconAlt?: string;
  gradient: string;
}

interface Props {
  titleLeading?: string;
  titleHighlight?: string;
  subtitle?: string;
  steps?: Step[];
}

const defaultSteps: Step[] = [
  {
    id: 1,
    stepNumber: "Step 1",
    title: "Discovery Call",
    description:
      "We begin with a comprehensive consultation to understand your phone system, call volume, and goals so we can design the perfect Voice AI solution for your business.",
    icon: "phone",
    gradient: "bg-[linear-gradient(135deg,rgba(43,127,255,1)_0%,rgba(152,16,250,1)_100%)]"
  },
  {
    id: 2,
    stepNumber: "Step 2",
    title: "Custom Solution Design",
    description:
      "We craft a tailored Voice AI Agent that mirrors your brand voice, handles your specific use cases, and integrates seamlessly with existing systems and workflows.",
    icon: "tool",
    gradient: "bg-[linear-gradient(135deg,rgba(173,70,255,1)_0%,rgba(246,51,154,1)_100%)]"
  },
  {
    id: 3,
    stepNumber: "Step 3",
    title: "Implementation & Integration",
    description:
      "Our team manages the full technical setup — phone routing, CRM connections, testing, and launch — to ensure everything works perfectly from day one.",
    icon: "bolt",
    gradient: "bg-[linear-gradient(135deg,rgba(96,165,250,1)_0%,rgba(167,139,250,1)_100%)]"
  },
  {
    id: 4,
    stepNumber: "Step 4",
    title: "Training & Ongoing Support",
    description:
      "We train your team, monitor performance, and provide continuous optimization and support so your Voice AI Agent keeps delivering results.",
    icon: "headset",
    gradient: "bg-[linear-gradient(135deg,rgba(142,81,255,1)_0%,rgba(59,130,246,1)_100%)]"
  }
];

const DEFAULT_GRADIENT = "linear-gradient(135deg,rgba(43,127,255,1)_0%,rgba(152,16,250,1)_100%)";

const getGradientBackground = (gradient?: string) => {
  if (!gradient) return DEFAULT_GRADIENT;
  const match = gradient.match(/bg-\[(.*)\]/);
  return match ? match[1] : gradient;
};

const {
  titleLeading = "How It Works",
  titleHighlight = "Our Process",
  subtitle = "From consultation to implementation, we guide you every step of the way",
  steps = defaultSteps
} = Astro.props as Props;

const iconMarkup: Record<IconName, string> = {
  phone: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="h-10 w-10 sm:h-12 sm:w-12"><path d="M22 16.92A16 16 0 0 1 7.08 2L5 4a2 2 0 0 0-.45 2.11l2.2 5.21a2 2 0 0 1-.57 2.22l-1.27 1.27a16 16 0 0 0 7.07 7.07l1.27-1.27a2 2 0 0 1 2.22-.57l5.21 2.2A2 2 0 0 0 20 19z"/></svg>`,
  tool: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="h-10 w-10 sm:h-12 sm:w-12"><path d="M14.7 6.3a4 4 0 0 0-5.6 5.6L5 16v3h3l4.1-4.1a4 4 0 0 0 5.6-5.6l1.8-1.8a3 3 0 0 0-4.2-4.2z"/><path d="m16 2 6 6"/></svg>`,
  bolt: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="h-10 w-10 sm:h-12 sm:w-12"><path d="M13 2 3 14h9l-1 8 10-12h-9z"/></svg>`,
  headset: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="h-10 w-10 sm:h-12 sm:w-12"><path d="M3 18v-6a9 9 0 0 1 18 0v6"/><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3z"/><path d="M3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/><path d="M18 22v-1a3 3 0 0 0-3-3H9a3 3 0 0 0-3 3v1"/></svg>`
};

const getIconMarkup = (step: Step) => {
  if (step.iconSrc) {
    return `<img src="${step.iconSrc}" alt="${
      step.iconAlt ?? `${step.title} icon`
    }" class="h-10 w-10 sm:h-12 sm:w-12 object-contain" loading="lazy" decoding="async" />`;
  }

  return step.icon ? iconMarkup[step.icon] : iconMarkup.phone;
};

const splitDescription = (html?: string) => {
  if (!html) {
    return { intro: "", rest: [] as string[] };
  }

  const matches = html.match(/<p[\s\S]*?<\/p>/g);

  if (!matches) {
    return { intro: html, rest: [] as string[] };
  }

  const cleaned = matches.map((segment) =>
    segment.replace(/^<p[^>]*>/, "").replace(/<\/p>$/, "").trim()
  );

  const [intro = "", ...rest] = cleaned;

  return { intro, rest };
};
---

<section class="relative mx-auto mt-24 max-w-6xl px-6 py-24">
  <header class="flex flex-col items-center gap-3 text-center">
    <h2 class="[font-family:'Segoe_UI_Symbol-Regular',Helvetica] text-3xl font-semibold leading-tight text-white sm:text-4xl md:text-[54px] md:leading-[64px]">
      <span>{titleLeading}</span>
      <span class="text-transparent bg-clip-text bg-[linear-gradient(90deg,#60a5fa_0%,#8b5cf6_100%)]">
        {titleHighlight}
      </span>
    </h2>
    <p
      class="[font-family:'Segoe_UI_Symbol-Regular',Helvetica] text-base leading-7 tracking-[0] text-[#9aa3b3] sm:text-lg"
      set:html={subtitle}
    ></p>
  </header>

  <div class="relative mt-16 space-y-6">
    {steps.map((step) => {
      const { intro, rest } = splitDescription(step.description);
      const gradientBackground = getGradientBackground(step.gradient);

      return (
        <article class="relative flex flex-col sm:flex-row rounded-[28px] border border-white/10 bg-[#0f172a]/60 p-6 shadow-[0_25px_80px_rgba(5,7,20,0.55)] backdrop-blur-lg">
          <div class="flex flex-col sm:flex-row items-start gap-6">
            <div
              class="flex h-20 w-20 md:h-24 md:w-24 items-center justify-center rounded-full text-white shadow-[0_18px_35px_rgba(11,76,140,0.45)] bg-[linear-gradient(155deg,rgba(43,127,255,0.1)_0%,rgba(43,127,255,0)_100%)]"
              style={`background:${gradientBackground};`}
            >
              <span class="sr-only">{step.title} icon</span>
              <span class="flex items-center justify-center" set:html={getIconMarkup(step)} />
            </div>

            <div class="flex-1 space-y-5 mt-4 sm:mt-0">
              <div class="space-y-2">
                <span class="text-xs font-semibold uppercase tracking-[0.4em] text-[#4ade80]">
                  {step.stepNumber}
                </span>
                <h3 class="text-2xl font-semibold leading-8 text-white">{step.title}</h3>
              </div>

              {intro && (
                <p class="text-base leading-7 text-[#d4ddf5]" set:html={intro}></p>
              )}

              {rest.length > 0 && (
                <div class="rounded-2xl border border-white/10 bg-white/5 p-5">
                  {rest.map((segment, idx) => (
                    <p
                      class={`howItWorks-card__callout-text text-sm leading-6 text-[#e2e8f0] ${
                        idx > 0 ? "mt-3 pt-3 border-t border-white/10" : ""
                      } ${idx === rest.length - 1 ? "font-semibold text-[#4ade80]" : ""}`}
                      set:html={segment}
                    ></p>
                  ))}
                </div>
              )}
            </div>
          </div>
        </article>
      );
    })}
  </div>
</section>

<style is:global>
  .howItWorks-card__callout-text strong {
    display: block;
    font-size: 0.75rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    margin-bottom: 0.35rem;
    color: #111c2d;
  }
</style>
